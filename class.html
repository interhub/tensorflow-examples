<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>classify with tensorflow</title>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@0.11.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.3.1/lib/p5.min.js"></script>

    <script>
        class PlaceTool {
            constructor(coord = [], index = 0) {
                this.x = coord[0]
                this.y = coord[1]
                this.index = index
            }
        }

        const data = [
            new PlaceTool([0.5, 0.5], 0),
            new PlaceTool([0.3, 0.7], 0),
            new PlaceTool([0.2, 0.4], 0),
            new PlaceTool([0.8, 0.1], 0),

            new PlaceTool([1.2, 0.4], 1),
            new PlaceTool([1.6, 0.2], 1),
            new PlaceTool([1.8, 0.8], 1),
            new PlaceTool([1.5, 0.1], 1),

            new PlaceTool([1.2, 1.1], 2),
            new PlaceTool([1.5, 1.3], 2),
            new PlaceTool([1.3, 1.8], 2),
            new PlaceTool([1.8, 1.5], 2),

            new PlaceTool([0.1, 1.8], 3),
            new PlaceTool([0.5, 1.2], 3),
            new PlaceTool([0.7, 1.8], 3),
            new PlaceTool([0.4, 1.5], 3),
        ]

        const x_vals = [] //[ [x,y], ... ]
        const y_vals = [] // [ index, ...]

        data.map(({x, y, index}) => {
            x_vals.push([x, y])
            y_vals.push(index)
        })

        const trainX = tf.tensor(x_vals)
        const trainY = tf.oneHot(tf.tensor1d(y_vals, 'int32'), 4)


        const learningRate = 0.3

        const model = tf.sequential()

        model.add(tf.layers.dense({units: 10, inputShape: [2], activation: 'sigmoid'}))
        model.add(tf.layers.dense({units: 4, activation: 'softmax'}))

        model.compile({loss: 'categoricalCrossentropy', optimizer: tf.train.adam(learningRate), metrics: ['accuracy']})

        async function fit() {
            await model.fit(trainX, trainY, {
                epochs: 400,
                yieldEvery: 'never',
            })
        }

        async function predictDraw() {
            strokeWeight(2)
            let x = map(mouseX, 0, width, 0, 2)
            let y = map(mouseY, 0, height, 0, 2)
            // console.log(x, y, 'coord')
            const predictInput = tf.tensor([[x, y]])
            const result = await model.predict(predictInput)
            // const resultData = result.dataSync()
            const resultMax = result.argMax(-1).dataSync()[0]

            console.log(resultMax, 'result place ✅ ')

            // background(0)
            // const coords = []
            // pointsY.map((y, key) => {
            //     coords.push([pointsX[key], y])
            // })
            // coords.reduce((a, b) => {
            //     if (a && b)
            //         line(a[0], a[1], b[0], b[1])
            //     return b
            // })
        }


        async function setup() {
            createCanvas(400, 400)
            background(0)
            stroke(255)
            strokeWeight(8)
            console.log('start fit ✅')
            await fit()
            console.log('end fit ✅')
        }


        function draw() {
            strokeWeight(6)
            for (let i = 0; i < x_vals.length; i++) {
                const index = y_vals[i]
                stroke(200 / index, 10 * index, 70 * index)
                let px = map(x_vals[i][0], 0, 2, 0, width)
                let py = map(x_vals[i][1], 0, 2, 0, height)
                // console.log(px, py, 'px, py')
                point(px, py)
            }
            //     //noLoop();
        }

        async function mousePressed() {
            strokeWeight(9)
            stroke(255)
            point(mouseX, mouseY)
            await predictDraw()
        }


    </script>
</head>
<body>
</body>
</html>
